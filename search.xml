<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>博客建立</title>
      <link href="/posts/1628c517.html"/>
      <url>/posts/1628c517.html</url>
      
        <content type="html"><![CDATA[<h1>博客上线</h1><p>博客以<code>hexo</code>框架为搭建基础；主题<a href="">Fomalhaut</a>。 建立过程比较顺利， 无需云主机。</p><p>建立前，我平时笔记都记录在本地<code>Typora</code>中，搭建博客呢，试想如果能无缝将本地笔记发布成线上博客就好了；建立初，就遇到个问题：<code>hexo</code>在markdown插入图片不显示</p><p>问题背景：我日常记录笔记使用的本地<code>Typora</code>软件， 插入图片使用相对路径<code>./images/xxx.jpg</code>(相对路径可以多平台切换)，图片存在本地，<code>hexo</code>本地文档放在<code>source/_posts/</code>目录下， 而<code>hexo</code>在生成静态文件时默认会忽略<code>source/_posts/</code>的资源，导致<code>public</code>目录下无图片；</p><p><img src="images/image-20240515110332814.png" alt="image-20240515110332814"></p><p>解决方案呢： ① 官网提供了<a href="https://hexo.io/zh-cn/docs/asset-folders">解决方案</a>， 该方案前提需要图片文件放在同文档名的文件夹下， 而我之前习惯是统一放在<code>.images/</code>下(具体原因有😂文件名可以随意修改，方便管理；本地所有文档的图片也均为此路径，更不想改习惯😂)，所以想方便(就是懒)点，遂方案①废弃；还有个不可行原因是主题<a href="">Fomalhaut</a>渲染后文件名会哈希成随机字符串，使用此方案， 静态文件中图片路径与资源文件名不匹配依然无法加载。</p><p>方案② 呢：我想是不是只要把<code>source/_posts/images</code>文件搬到<code>public/post/images</code>下就行了, 说干就干<br>第一步，让<code>_posts/images</code>在生成静态文件时不被忽略，根据官方文档在<code>_config.yml</code>中配置</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">include:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&quot;_posts/images/*&quot;</span></span><br></pre></td></tr></table></figure><p>执行<code>hexo generate</code></p><img src="images/image-20240515112419512.png" alt="image-20240515112419512" style="zoom:80%;" /><p>到这完成了第一步，<code>public</code>目录下生成的静态文件夹是<code>posts</code>而非<code>_posts</code>😂，接下来怎么办？看下源码，试着找到静态文件生成的逻辑，然后改一下呢，说干就干</p><p>2000 years later… 终于在<code>./node_modules/hexo/lib/plugins/console/generate.js</code>发现了端倪，此文件会执行写入并生成文件操作</p><p>在<code>wrigeFile(path)</code>函数中添加<code>path = path.replace('_posts/', 'posts/');</code>去改变下文件生成路径</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">generateFile</span>(<span class="params">path</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> publicDir = <span class="variable language_">this</span>.<span class="property">context</span>.<span class="property">public_dir</span>;</span><br><span class="line">  <span class="keyword">const</span> &#123; generatingFiles &#125; = <span class="variable language_">this</span>;</span><br><span class="line">  <span class="keyword">const</span> &#123; route, log &#125; = <span class="variable language_">this</span>.<span class="property">context</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 如果文件正在生成则跳过</span></span><br><span class="line">  <span class="keyword">if</span> (generatingFiles.<span class="title function_">has</span>(path)) <span class="keyword">return</span> <span class="title class_">Promise</span>.<span class="title function_">resolve</span>();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Lock the file</span></span><br><span class="line">  generatingFiles.<span class="title function_">add</span>(path);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> promise;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 执行写入操作</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">force</span>) &#123;</span><br><span class="line">    promise = <span class="variable language_">this</span>.<span class="title function_">writeFile</span>(path, <span class="literal">true</span>);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> dest = <span class="title function_">join</span>(publicDir, path);</span><br><span class="line">    promise = <span class="title function_">exists</span>(dest).<span class="title function_">then</span>(<span class="function"><span class="params">exist</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (!exist) <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="title function_">writeFile</span>(path, <span class="literal">true</span>);</span><br><span class="line">      <span class="keyword">if</span> (route.<span class="title function_">isModified</span>(path)) <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="title function_">writeFile</span>(path);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> promise.<span class="title function_">finally</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// Unlock the file</span></span><br><span class="line">    generatingFiles.<span class="title function_">delete</span>(path);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;  </span><br><span class="line"></span><br><span class="line"><span class="title function_">writeFile</span>(<span class="params">path, force</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; route, log &#125; = <span class="variable language_">this</span>.<span class="property">context</span>;</span><br><span class="line">  <span class="keyword">const</span> publicDir = <span class="variable language_">this</span>.<span class="property">context</span>.<span class="property">public_dir</span>;</span><br><span class="line">  <span class="keyword">const</span> <span class="title class_">Cache</span> = <span class="variable language_">this</span>.<span class="property">context</span>.<span class="title function_">model</span>(<span class="string">&#x27;Cache&#x27;</span>);</span><br><span class="line">  <span class="keyword">const</span> dataStream = <span class="variable language_">this</span>.<span class="title function_">wrapDataStream</span>(route.<span class="title function_">get</span>(path));</span><br><span class="line">  <span class="keyword">const</span> buffers = [];</span><br><span class="line">  <span class="keyword">const</span> hasher = <span class="title function_">createSha1Hash</span>();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 在此处将 path 替换 &#x27;_posts/&#x27; 为 &#x27;posts/&#x27;, 为了_posts/images下的图片放在public/posts/images目录下</span></span><br><span class="line">  path = path.<span class="title function_">replace</span>(<span class="string">&#x27;_posts/&#x27;</span>, <span class="string">&#x27;posts/&#x27;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> finishedPromise = <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">    dataStream.<span class="title function_">once</span>(<span class="string">&#x27;error&#x27;</span>, reject);</span><br><span class="line">    dataStream.<span class="title function_">once</span>(<span class="string">&#x27;end&#x27;</span>, resolve);</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Get data =&gt; Cache data =&gt; Calculate hash</span></span><br><span class="line">  dataStream.<span class="title function_">on</span>(<span class="string">&#x27;data&#x27;</span>, <span class="function"><span class="params">chunk</span> =&gt;</span> &#123;</span><br><span class="line">    buffers.<span class="title function_">push</span>(chunk);</span><br><span class="line">    hasher.<span class="title function_">update</span>(chunk);</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> finishedPromise.<span class="title function_">then</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> dest = <span class="title function_">join</span>(publicDir, path);</span><br><span class="line">    <span class="keyword">const</span> cacheId = <span class="string">`public/<span class="subst">$&#123;path&#125;</span>`</span>;</span><br><span class="line">    <span class="keyword">const</span> cache = <span class="title class_">Cache</span>.<span class="title function_">findById</span>(cacheId);</span><br><span class="line">    <span class="keyword">const</span> hash = hasher.<span class="title function_">digest</span>(<span class="string">&#x27;hex&#x27;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Skip generating if hash is unchanged</span></span><br><span class="line">    <span class="keyword">if</span> (!force &amp;&amp; cache &amp;&amp; cache.<span class="property">hash</span> === hash) &#123;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Save new hash to cache</span></span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Cache</span>.<span class="title function_">save</span>(&#123;</span><br><span class="line">      <span class="attr">_id</span>: cacheId,</span><br><span class="line">      hash</span><br><span class="line">    &#125;).<span class="title function_">then</span>(<span class="function">() =&gt;</span> <span class="comment">// Write cache data to public folder</span></span><br><span class="line">      <span class="title function_">writeFile</span>(dest, <span class="title class_">Buffer</span>.<span class="title function_">concat</span>(buffers))).<span class="title function_">then</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      log.<span class="title function_">info</span>(<span class="string">&#x27;Generated: %s&#x27;</span>, <span class="title function_">magenta</span>(path));</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>改完重新执行generate命令， 成功生成在<code>posts/images</code>下</p><p><img src="images/image-20240515164040033.png" alt="image-20240515164040033"></p><p>静态文件中图片也是相对路径那么现在就可以成功访问图片了😊。</p><p>[后记] ： 使用后不时还是发生了图片不显示问题？🧐！<code>hexo</code>将<code>md</code>文件中的图片解析成<code>html</code>的<code>&lt;img src=&quot;&quot;&gt;</code>时， 居然发生了奇怪的现象？？如下<br><img src="images/image-20240515161711359.png" alt="image-20240515161711359"></p><p>居然生成<code>src</code>路径时在相对和绝对路径中摇摆不定？事前声明我本地Typora文档中图片只有相对路径<code>images/xx</code>和<code>./images/xx</code>两种情况；按理来说你要是全部加上<code>/</code>我也能处理下， 但是有的加有的不加什么情况？</p><p>那再从源码出处看看什么情况，在看源码期间又想到了个好办法&quot;你怎么解析的我不管， 解析完后我处理下不也可以吗&quot;</p><p>于是在<code>butterfly</code>主题包下<code>post_lazyload.js</code>中注册的过滤器内添加正则替换</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Butterfly</span></span><br><span class="line"><span class="comment"> * lazyload</span></span><br><span class="line"><span class="comment"> * replace src to data-lazy-src</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">&#x27;use strict&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> &#123;log&#125; = <span class="built_in">require</span>(<span class="string">&quot;hexo/lib/plugins/helper/debug&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> urlFor = <span class="built_in">require</span>(<span class="string">&#x27;hexo-util&#x27;</span>).<span class="property">url_for</span>.<span class="title function_">bind</span>(hexo)</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">lazyload</span> (htmlContent) &#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 使用正则表达式匹配所有的 &lt;img&gt; 标签，并替换其中的 src 属性</span></span><br><span class="line">  <span class="keyword">let</span> processedContent = htmlContent.<span class="title function_">replace</span>(<span class="regexp">/&lt;img\s+src=[&quot;&#x27;](?:\/?\.?\/?)(\/?images\/.*?)[&quot;&#x27;]/ig</span>, <span class="string">&#x27;&lt;img src=&quot;$1&quot;&#x27;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> bg = hexo.<span class="property">theme</span>.<span class="property">config</span>.<span class="property">lazyload</span>.<span class="property">placeholder</span> ? <span class="title function_">urlFor</span>(hexo.<span class="property">theme</span>.<span class="property">config</span>.<span class="property">lazyload</span>.<span class="property">placeholder</span>) : <span class="string">&#x27;data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7&#x27;</span>;</span><br><span class="line">  processedContent = processedContent.<span class="title function_">replace</span>(<span class="regexp">/(&lt;img.*? src=)/ig</span>, <span class="string">`$1 &quot;<span class="subst">$&#123;bg&#125;</span>&quot; data-lazy-src=`</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> processedContent;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">hexo.<span class="property">extend</span>.<span class="property">filter</span>.<span class="title function_">register</span>(<span class="string">&#x27;after_render:html&#x27;</span>, <span class="keyword">function</span> (<span class="params">data</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> config = hexo.<span class="property">theme</span>.<span class="property">config</span>.<span class="property">lazyload</span></span><br><span class="line">  <span class="keyword">if</span> (!config.<span class="property">enable</span>) <span class="keyword">return</span></span><br><span class="line">  <span class="keyword">if</span> (config.<span class="property">field</span> !== <span class="string">&#x27;site&#x27;</span>) <span class="keyword">return</span></span><br><span class="line">  <span class="keyword">return</span> lazyload.<span class="title function_">call</span>(<span class="variable language_">this</span>, data)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">hexo.<span class="property">extend</span>.<span class="property">filter</span>.<span class="title function_">register</span>(<span class="string">&#x27;after_post_render&#x27;</span>, <span class="function"><span class="params">data</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> config = hexo.<span class="property">theme</span>.<span class="property">config</span>.<span class="property">lazyload</span></span><br><span class="line">  <span class="keyword">if</span> (!config.<span class="property">enable</span>) <span class="keyword">return</span></span><br><span class="line">  <span class="keyword">if</span> (config.<span class="property">field</span> !== <span class="string">&#x27;post&#x27;</span>) <span class="keyword">return</span></span><br><span class="line">  data.<span class="property">content</span> = lazyload.<span class="title function_">call</span>(<span class="variable language_">this</span>, data.<span class="property">content</span>)</span><br><span class="line">  <span class="keyword">return</span> data</span><br><span class="line">&#125;)</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>重新生成<br><img src="images/image-20240515163420934.png" alt="image-20240515163420934"><br>看图片路径已全部变成相对路径, 大功告成</p><p>现在呢， 我就实现了将本地笔记可直接发布成博客的方案， 而不需要修改什么。</p><p>方案③呢， 使用图床，但是我日常习惯还是本地<code>Typora</code>记录，无网络限制，遂暂不采用</p><h1>未来展望</h1><p><img src="images/image-20240514180751428.png" alt="future"></p><p>在之前的工作中，也有记录的习惯，遇到些技术难点或线上问题等疑难杂症会在本地<code>Typora</code>中记录，不过呢目的是给自己看😂;  建立博客呢，一方面督促自己，学无止境；另一方面以前也从很多人的博客中受到帮助，所以学会分享，形成闭环。</p><p>未来，我会本地记录中挑选写有价值的文章整理后发布(😂以前是让自己看懂，博客要能让别人看懂)，并且在学习一些新技术并有深刻收获后也在此记录。</p>]]></content>
      
      
      
    </entry>
    
    
  
  
</search>
